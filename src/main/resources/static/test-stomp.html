<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>STOMP Realtime Test</title>

    <!-- ğŸ”¥ ë°˜ë“œì‹œ í•„ìš” -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

    <style>
        body { font-family: sans-serif; padding: 16px; }
        input { width: 120px; }
        button { margin-right: 6px; }
        pre { background: #111; color: #0f0; padding: 12px; height: 360px; overflow: auto; }
        .row { margin-bottom: 10px; }
    </style>
</head>
<body>

<h3>Realtime STOMP Test</h3>

<div class="row">
    StockCode:
    <input id="code" value="005930" />

    Scope:
    <select id="scope">
        <option value="persistent">persistent (ë©”ì¸)</option>
        <option value="page">page (ìƒì„¸)</option>
    </select>

    Virtual:
    <select id="virtual">
        <option value="false">false (ì‹¤ì„œë²„)</option>
        <option value="true">true (ëª¨ì˜ì„œë²„)</option>
    </select>

    <button onclick="connect()">connect</button>
    <button onclick="subscribe()">subscribe</button>
    <button onclick="unsubscribe()">unsubscribe</button>
    <button onclick="disconnect()">disconnect</button>
</div>

<pre id="log"></pre>

<script>
    let client;
    const subs = {};

    const logEl = document.getElementById("log");
    const log = (m) => {
        logEl.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`;
        logEl.scrollTop = logEl.scrollHeight;
    };

    function connect() {
        if (client?.active || client?.connected) {
            log("âš  already connected");
            return;
        }

        // ğŸ”¥ í•µì‹¬: brokerURL âŒ / SockJS âœ…
        client = new StompJs.Client({
            webSocketFactory: () => new SockJS("http://localhost:8081/ws"),
            reconnectDelay: 0,
            debug: msg => log("[STOMP] " + msg),

            onConnect: () => log("âœ… CONNECTED"),
            onDisconnect: () => log("ğŸ”Œ DISCONNECTED"),
            onStompError: f => log("âŒ STOMP ERROR " + (f?.body ?? "")),
            onWebSocketError: e => log("âŒ WS ERROR " + (e?.message ?? e))
        });

        client.activate();
    }

    function subscribe() {
        if (!client?.connected) {
            log("âŒ not connected");
            return;
        }

        const code = document.getElementById("code").value.trim();
        if (!code) {
            log("âŒ stockCode empty");
            return;
        }

        if (subs[code]) {
            log("âš  already subscribed " + code);
            return;
        }

        const scope = document.getElementById("scope").value;
        const virtual = document.getElementById("virtual").value;
        const dest = `/topic/realtime-price/${code}`;

        const headers = {
            scope,
            virtual
        };

        const sub = client.subscribe(
            dest,
            msg => log(`ğŸ“© [${code}] ${msg.body}`),
            headers
        );

        subs[code] = sub;
        log(`âœ… SUBSCRIBE ${code}`);
    }

    function unsubscribe() {
        const code = document.getElementById("code").value.trim();
        const sub = subs[code];

        if (!sub) {
            log("âš  no subscription");
            return;
        }

        sub.unsubscribe();
        delete subs[code];
        log(`âœ… UNSUBSCRIBE ${code}`);
    }

    function disconnect() {
        Object.values(subs).forEach(s => {
            try { s.unsubscribe(); } catch (_) {}
        });

        for (const k in subs) delete subs[k];

        if (client) {
            client.deactivate();
            client = null;
        }

        log("ğŸ”Œ DEACTIVATE CALLED");
    }
</script>

</body>
</html>